<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Nginx | 杨旋,&quot;你好&quot;</title><meta name="author" content="Yez Sun,757224748@qq.com"><meta name="copyright" content="Yez Sun"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="Nginx简介概述：Nginx是高性能的HTTP和反向代理的服务器，处理高并发能力是十分强大的，能经受高负载的考验。 Nginx四个常用版本Nginx开源版、Nginx plus商业版、Openresty、Tengine Nginx的安装编译安装  在Nginx官网下载并解压 1234# 通过wget下载wget http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.21.6.tar">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx">
<meta property="og:url" content="https://sunshine-boy-yez.github.io/2022/03/27/Nginx/index.html">
<meta property="og:site_name" content="杨旋,&quot;你好&quot;">
<meta property="og:description" content="Nginx简介概述：Nginx是高性能的HTTP和反向代理的服务器，处理高并发能力是十分强大的，能经受高负载的考验。 Nginx四个常用版本Nginx开源版、Nginx plus商业版、Openresty、Tengine Nginx的安装编译安装  在Nginx官网下载并解压 1234# 通过wget下载wget http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.21.6.tar">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2022-03-27T05:49:31.000Z">
<meta property="article:modified_time" content="2022-05-23T03:28:23.661Z">
<meta property="article:author" content="Yez Sun">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/Hexoicon.png"><link rel="canonical" href="https://sunshine-boy-yez.github.io/2022/03/27/Nginx/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"limitCount":50,"languages":{"author":"Author: Yez Sun","link":"Link: ","source":"Source: 杨旋,\"你好\"","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source."}},
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-23 11:28:23'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/zhiZhu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">16</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">1</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">杨旋,&quot;你好&quot;</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">Nginx</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-03-27T05:49:31.000Z" title="Created 2022-03-27 13:49:31">2022-03-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-05-23T03:28:23.661Z" title="Updated 2022-05-23 11:28:23">2022-05-23</time></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h4 id="Nginx简介"><a href="#Nginx简介" class="headerlink" title="Nginx简介"></a>Nginx简介</h4><p>概述：Nginx是高性能的HTTP和反向代理的服务器，处理高并发能力是十分强大的，能经受高负载的考验。</p>
<h5 id="Nginx四个常用版本"><a href="#Nginx四个常用版本" class="headerlink" title="Nginx四个常用版本"></a>Nginx四个常用版本</h5><p><a target="_blank" rel="noopener" href="http://nginx.org/">Nginx</a>开源版、<a target="_blank" rel="noopener" href="https://www.nginx.com/">Nginx plus</a>商业版、<a target="_blank" rel="noopener" href="http://openresty.org/">Openresty</a>、<a target="_blank" rel="noopener" href="http://tengine.taobao.org/">Tengine</a></p>
<h5 id="Nginx的安装"><a href="#Nginx的安装" class="headerlink" title="Nginx的安装"></a>Nginx的安装</h5><p><strong>编译安装</strong></p>
<ol>
<li><p>在<a target="_blank" rel="noopener" href="http://nginx.org/en/download.html">Nginx</a>官网下载并解压</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过wget下载</span></span><br><span class="line">wget http://nginx.org/download/nginx-1.21.6.tar.gz</span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line">tar -zxvf nginx-1.21.6.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入Nginx目录进行编译安装与依赖检查</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 缺少gcc依赖</span></span><br><span class="line">yum install -y gcc</span><br><span class="line"><span class="comment"># 缺少perl库</span></span><br><span class="line">yum install -y pcre pcre-devel</span><br><span class="line"><span class="comment"># 缺少zlib库</span></span><br><span class="line">yum install -y zlib zlib-devel</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/nginx</span><br><span class="line">make $$ make install</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><strong>yum安装</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加Nginx到yum源</span></span><br><span class="line">rpm -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装Nginx</span></span><br><span class="line">yum install -y nginx</span><br></pre></td></tr></table></figure>

<p>目录结构</p>
<ul>
<li>网站文件存放默认目录：/usr/share/nginx/html</li>
<li>网站日志文件：/var/log/nginx</li>
<li>Nginx全局配置文件：/etc/nginx/nginx.conf</li>
<li>自定义Nginx站点配置文件存放目录：/etc/nginx/conf.d/</li>
<li>网站默认站点配置：/etc/nginx/conf.d/default.conf</li>
</ul>
<h5 id="开放防火墙端口"><a href="#开放防火墙端口" class="headerlink" title="开放防火墙端口"></a>开放防火墙端口</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看防火墙端口开放信息</span></span><br><span class="line">firewall-cmd --list-all</span><br><span class="line"><span class="comment"># 开放80端口</span></span><br><span class="line">firewall-cmd --zone=public --permanent --add-port=80/tcp</span><br><span class="line"><span class="comment"># 重载防火墙</span></span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<h5 id="Nginx启停"><a href="#Nginx启停" class="headerlink" title="Nginx启停"></a>Nginx启停</h5><p>（进入安装好的目录 /usr/local/nginx/sbin ）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">./nginx</span><br><span class="line"><span class="comment"># 快速停止</span></span><br><span class="line">./nginx -s stop</span><br><span class="line"><span class="comment"># 优雅关闭，在退出前完成已经接受的连接请求</span></span><br><span class="line">./nginx -s quit</span><br><span class="line"><span class="comment"># 重新加载配置</span></span><br><span class="line">./nginx -s reload</span><br></pre></td></tr></table></figure>

<h5 id="安装成系统服务"><a href="#安装成系统服务" class="headerlink" title="安装成系统服务"></a>安装成系统服务</h5><p>（通过yum安装的会自动安装成系统服务）</p>
<ol>
<li><p>创建服务脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/nginx.service</span><br></pre></td></tr></table></figure>

<p>服务脚本内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 服务的说明</span><br><span class="line">[Unit]</span><br><span class="line"># 描述服务</span><br><span class="line">Description&#x3D;nginx - high performance web server</span><br><span class="line"># 描述服务类别</span><br><span class="line">After&#x3D;network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line"># 服务运行参数的设置</span><br><span class="line">[Service]</span><br><span class="line"># 后台运行的形式</span><br><span class="line">Type&#x3D;forking</span><br><span class="line">PIDFile&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;logs&#x2F;nginx.pid</span><br><span class="line">ExecStartPre&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -t -c &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf </span><br><span class="line"># 运行</span><br><span class="line">ExecStart&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -c &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf </span><br><span class="line"># 重载</span><br><span class="line">ExecReload&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s reload</span><br><span class="line"># 停止</span><br><span class="line">ExecStop&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s stop</span><br><span class="line">ExecQuit&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s quit</span><br><span class="line">PrivateTmp&#x3D;true</span><br><span class="line"></span><br><span class="line"># 服务安装的相关配置，可设置为多用户</span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;multi-user.target</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新加载系统服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>Nginx启停</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启、关闭、重新加载、查看状态</span></span><br><span class="line">systemctl [start|stop|restart|status] nginx.service</span><br><span class="line"><span class="comment"># 设置开机自启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> nginx.service</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="Nginx基本使用"><a href="#Nginx基本使用" class="headerlink" title="Nginx基本使用"></a>Nginx基本使用</h4><h5 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h5><ul>
<li>client_body_temp、fastcgi_temp、logs proxy_temp、scgi_temp、uwsgi_temp（主要用来存放运行过程中的临时文件，在刚安装后是没有的）</li>
<li>sbin（nginx的主程序）</li>
<li>conf（用来存放配置文件相关）</li>
<li>html（用来存放静态文件的默认目录）</li>
<li>logs（用于存放访问日志和错误日志文件）</li>
</ul>
<h6 id="nginx-conf配置文件"><a href="#nginx-conf配置文件" class="headerlink" title="nginx.conf配置文件"></a>nginx.conf配置文件</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># 表示开启一个业务进程，worker数和服务器cpu数相等最为适宜</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line"># 单个业务进程可接受连接数，每个请求占用work的2（静态访问）或4（反向代理）个连接数</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">	# 引入http mime类型</span><br><span class="line">    include       mime.types;</span><br><span class="line">    # 如果mime类型没匹配上，默认使用二进制流的方式传输</span><br><span class="line">    default_type  application&#x2F;octet-stream;</span><br><span class="line"></span><br><span class="line">    # 使用linux的 sendfile(socket, file, len) 高效网络传输，也就是数据0拷贝</span><br><span class="line">    sendfile        on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">	# 虚拟主机配置</span><br><span class="line">    server &#123;</span><br><span class="line">    	# 监听IP与端口号</span><br><span class="line">        listen       80;</span><br><span class="line">        # 设置服务器名</span><br><span class="line">        server_name  192.168.91.129;</span><br><span class="line">		# 匹配URI</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">        	# 文件主目录</span><br><span class="line">			root   html;</span><br><span class="line">			# 默认页名称</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		# 报错编码对应页面</span><br><span class="line">        error_page   500 502 503 504  &#x2F;50x.html;</span><br><span class="line">        location &#x3D; &#x2F;50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>ps：通过nginx -t检查配置文件的正确性。</em></p>
<p><strong>Nginx原理</strong></p>
<p>![masterAndWorker](D:\program files\YEZ_Blog\blog\source_posts\Nginx\masterAndWorker.png)</p>
<p><strong>listen指令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen [address:][port] [options];</span><br></pre></td></tr></table></figure>

<p>附加选项option：<br>    default_server：指定此server块定义的IP地址和端口组合作为默认的虚拟主机<br>    ssl：指定只有HTTPS连接才使用这个端口<br>    ipv6only=on：指定listen仅监听IPv6地址</p>
<p><strong>servername匹配规则</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 完整匹配</span><br><span class="line">server_name	vod.yez.com www.yez.com;</span><br><span class="line"># 通配符匹配</span><br><span class="line">server_name	*.yez.com;</span><br><span class="line">server_name	www.yez.*;</span><br><span class="line"># 正则匹配</span><br><span class="line">server_name ~^[0-9]+\.yez\.com$;</span><br></pre></td></tr></table></figure>

<p><em>ps：我们可以在同一servername中匹配多个域名，servername匹配分先后顺序，写在前面的匹配上就不会继续往下匹配了。</em></p>
<p><strong>location前缀</strong></p>
<ul>
<li>/ 通用匹配，任何请求都会匹配到</li>
<li>= 精准匹配，不是以指定模式开头</li>
<li>~ 正则匹配，区分大小写</li>
<li>~* 正则匹配，不区分大小写</li>
<li>^~ 非正则匹配，匹配以指定模式开头的location</li>
</ul>
<p><strong>location匹配顺序</strong></p>
<ul>
<li>多个正则location直接按书写顺序匹配，成功后就不会继续往后面匹配</li>
<li>普通（非正则）location会一直往下，直到找到匹配度最高的（最大前缀匹配）</li>
<li>当普通location与正则location同时存在，如果正则匹配成功,则不会再执行普通匹配</li>
<li>所有类型location存在时，“=”匹配 &gt; “^~”匹配 &gt; 正则匹配 &gt; 普通（最大前缀匹配）</li>
</ul>
<p><strong>root与alias</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;css &#123;</span><br><span class="line">	alias &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;static&#x2F;css;</span><br><span class="line">	index index.html index.htm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>root用来设置根目录，而alias在接受请求的时候在路径上不会加上location。</p>
<ol>
<li>alias指定的目录是准确的，即location匹配访问的path目录下的文件直接是在alias目录下查找的。</li>
<li>root指定的目录是location匹配访问的path目录的上一级目录,这个path目录一定要是真实存在root指定目录下的。</li>
<li>使用alias标签的目录块中不能使用rewrite的break；另外，alias指定的目录后面必须要加上”/“符号。</li>
<li>alias虚拟目录配置中，location匹配的path目录如果后面不带”/“，那么访问的url地址中这个path目录后面加不加”/“不影响访问，访问时它会自动加上”/“； 但是如果location匹配的path目录后面加上”/“，那么访问的url地址中这个path目录必须要加上”/“，访问时它不会自动加上”/“。如果不加上”/“，访问就会失败！</li>
<li>root目录配置中，location匹配的path目录后面带不带”/“，都不会影响访问。</li>
</ol>
<h5 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h5><p>需要在客户端配置代理服务器来进行指定网站的访问</p>
<p>![posProxy](D:\program files\YEZ_Blog\blog\source_posts\Nginx\posProxy.png)</p>
<h5 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h5><p>暴露的是代理服务器地址，隐藏了真实服务器IP地址</p>
<p>![negProxy](D:\program files\YEZ_Blog\blog\source_posts\Nginx\negProxy.png)</p>
<pre><code># 启动三台tomcat服务器，分别设置端口及开放防火墙端口，在端口分别为8081、8082的tomcat的webapp目录下分别创建一个目录，目录下创建不同html文件进行访问

# 测试反向代理1
location / &#123;
    proxy_pass http://192.168.91.129:8080;
    root   html;
    index  index.html index.htm;
&#125;

# 测试反向代理2
location ~ /yx/ &#123;
    proxy_pass http://192.168.91.129:8081;
&#125;
location ~ /yez/ &#123;
    proxy_pass http://192.168.91.129:8082;
&#125;</code></pre>
<h5 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h5><p>增加服务器的数量，然后将请求分发到各个服务器上，将原先请求集中到单个服务器上的情况改为将请求分发到多个服务器上，将负载分发到不同的服务器。</p>
<p>![loadBalance](D:\program files\YEZ_Blog\blog\source_posts\Nginx\loadBalance.png)</p>
<pre><code># 在端口分别为8081、8082的tomcat的webapp目录下创建一个相同目录，目录下创建不同html文件进行访问

# 放在server同级目录下
upstream myserver &#123;
    server    192.168.91.129:8081;
    server    192.168.91.129:8082;
&#125;

location ~ /y/ &#123;
    proxy_pass http://myserver;
&#125;</code></pre>
<h6 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h6><ol>
<li><p>轮询：默认情况下使用轮询方式，逐一转发，这种方式适用于无状态请求</p>
</li>
<li><p>weight(权重)：指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况</p>
<ul>
<li>weight：默认为1，weight越大，负载的权重就越大</li>
<li>down：表示当前的server暂时不参与负载</li>
<li>backup： 其它所有的非backup机器down或者忙的时候，请求backup机器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream httpd &#123; </span><br><span class="line">	server	192.168.91.129:8081 weight&#x3D;10 down; </span><br><span class="line">	server	192.168.91.129:8082 weight&#x3D;1 backup; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ip_hash：根据客户端的ip地址转发同一台服务器，可以保持回话</p>
</li>
<li><p>least_conn：最少连接访问</p>
</li>
<li><p>url_hash：根据用户访问的url定向转发请求</p>
</li>
<li><p>fair：根据后端服务器响应时间转发请求</p>
</li>
</ol>
<h5 id="动静分离"><a href="#动静分离" class="headerlink" title="动静分离"></a>动静分离</h5><p>![dynAndsta](D:\program files\YEZ_Blog\blog\source_posts\Nginx\dynAndsta.png)</p>
<pre><code>location /www/ &#123;
    root /usr/local/nginx/static;
    autoindex on;    #列出访问目录
&#125;
location /image/ &#123;
    root /usr/local/nginx/static;
&#125;
location /css/ &#123;
    root /usr/local/nginx/static;
&#125;
location /js/ &#123;
    root /usr/local/nginx/static;
&#125;</code></pre>
<h5 id="URLReWrite伪静态配置"><a href="#URLReWrite伪静态配置" class="headerlink" title="URLReWrite伪静态配置"></a>URLReWrite伪静态配置</h5><p>rewrite是实现URL重写的关键指令，根据regex (正则表达式)部分内容， 重定向到replacement，结尾是flag标记。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 关键字 正则 替换内容 flag标记</span><br><span class="line">rewrite &lt;regex&gt; &lt;replacement&gt; [flag];</span><br></pre></td></tr></table></figure>

<p>flag标记说明：<br>    last：本条规则匹配完成后，继续向下匹配新的location URI规则<br>    break：本条规则匹配完成即终止，不再匹配后面的任何规则<br>    redirect：返回302临时重定向，浏览器地址会显示跳转后的URL地址<br>    permanent：返回301永久重定向，浏览器地址栏会显示跳转后的URL地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># http:&#x2F;&#x2F;192.168.91.129:8080&#x2F;123.html 重写到 http:&#x2F;&#x2F;192.168.91.129:8080&#x2F;index.jsp?pageNum&#x3D;123</span><br><span class="line"></span><br><span class="line">location &#x2F; &#123;</span><br><span class="line">	rewrite ^&#x2F;([0-9]+).html$ &#x2F;index.jsp?pageNum&#x3D;$1 break;</span><br><span class="line">	proxy_pass http:&#x2F;&#x2F;192.168.91.129:8080;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="真实服务器禁止外网访问"><a href="#真实服务器禁止外网访问" class="headerlink" title="真实服务器禁止外网访问"></a>真实服务器禁止外网访问</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭防火墙对应的tomcat端口</span></span><br><span class="line">firewall-cmd --zone=public --permanent --remove-port=8080/tcp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定端口和ip访问</span></span><br><span class="line">firewall-cmd --permanent --add-rich-rule=<span class="string">&quot;rule family=&quot;</span>ipv4<span class="string">&quot; source address=&quot;</span>192.168.91.129<span class="string">&quot; port protocol=&quot;</span>tcp<span class="string">&quot; port=&quot;</span>8080<span class="string">&quot; accept&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重载防火墙</span></span><br><span class="line">firewall-cmd --reload </span><br><span class="line"></span><br><span class="line"><span class="comment"># 移除规则</span></span><br><span class="line"><span class="comment"># firewall-cmd --permanent --remove-rich-rule=&quot;rule family=&quot;ipv4&quot; source address=&quot;192.168.91.129&quot; port port=&quot;8080&quot; protocol=&quot;tcp&quot; accept&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="防盗链配置"><a href="#防盗链配置" class="headerlink" title="防盗链配置"></a>防盗链配置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">valid_referers none | blocked | server_names | strings ....;</span><br></pre></td></tr></table></figure>

<ul>
<li>server_names ，设置一个或多个 URL ，检测 Referer 头域的值是否是这些 URL 中的某一个。</li>
<li>none， 检测 Referer 头域不存在的情况。</li>
<li>blocked，检测 Referer 头域的值被防火墙或者代理服务器删除或伪装的情况，这种情况该头域的值不以“http://” 或 “https://” 开头。</li>
</ul>
<p>在需要防盗链的location中配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">valid_referers 192.168.91.129;</span><br><span class="line">if ($invalid_referer) &#123;</span><br><span class="line">	return 403;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="使用curl测试"><a href="#使用curl测试" class="headerlink" title="使用curl测试"></a>使用curl测试</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装curl</span></span><br><span class="line">yum install -y curl</span><br><span class="line"></span><br><span class="line">curl -I http://192.168.91.129/img/logo.png</span><br><span class="line">curl -e <span class="string">&quot;http://baidu.com&quot;</span> http://192.168.91.129/img/logo.png</span><br></pre></td></tr></table></figure>

<h5 id="高可用配置"><a href="#高可用配置" class="headerlink" title="高可用配置"></a>高可用配置</h5><p>![HA](D:\program files\YEZ_Blog\blog\source_posts\Nginx\HA.png)</p>
<h6 id="安装Keepalived"><a href="#安装Keepalived" class="headerlink" title="安装Keepalived"></a>安装Keepalived</h6><p><strong>编译安装</strong></p>
<ol>
<li><p>在<a target="_blank" rel="noopener" href="https://www.keepalived.org/download.html">Keepalived</a>官网下载并解压</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过wget下载</span></span><br><span class="line">wget https://www.keepalived.org/software/keepalived-2.0.20.tar.gz</span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line">tar -zxvf keepalived-2.0.20.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入Keepalived目录进行编译安装与依赖检查</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 缺少openssl依赖</span></span><br><span class="line">yum install -y openssl openssl-devel</span><br><span class="line">./configure</span><br><span class="line">make $$ make install</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><strong>yum安装</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br></pre></td></tr></table></figure>

<ul>
<li>配置文件：/etc/keepalived/keepalived.conf</li>
</ul>
<h6 id="keepalived-conf配置文件"><a href="#keepalived-conf配置文件" class="headerlink" title="keepalived.conf配置文件"></a>keepalived.conf配置文件</h6><p><strong>主机配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"># 全局配置</span><br><span class="line">global_defs &#123;</span><br><span class="line">   # 设置主机</span><br><span class="line">   smtp_server 192.168.91.128</span><br><span class="line">   # 设置虚拟机与主机连接超时时间</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   # 唯一标识信息，可以设置为&#x2F;etc&#x2F;hosts中配置的主机名</span><br><span class="line">   router_id host1</span><br><span class="line">   # 设置脚本的用户为root</span><br><span class="line">   script_user root</span><br><span class="line">   # 开启脚本安全模式</span><br><span class="line">   enable_script_security</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 脚本配置</span><br><span class="line">vrrp_script chk_http_port &#123;</span><br><span class="line">   # 设置监控脚本</span><br><span class="line">   script &quot;&#x2F;usr&#x2F;local&#x2F;src&#x2F;nginx_check.sh&quot;</span><br><span class="line">   # 设置监控脚本执行间隔(后面不能有空格)</span><br><span class="line">   interval 2</span><br><span class="line">   # 监控脚本执行异常则-20权重</span><br><span class="line">   weight -20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># vrrp示例配置</span><br><span class="line">vrrp_instance yez &#123;</span><br><span class="line">    # 设置状态，主机MASTER、从机BACKUP</span><br><span class="line">    state MASTER</span><br><span class="line">    # 接口，也就是物理网卡，主从可以设置同名的网卡</span><br><span class="line">    interface ens33</span><br><span class="line">    # 虚拟路由器的id，主从必须相同</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    # 设置本机优先级为100，可以为0～254，主要比从高</span><br><span class="line">    priority 100</span><br><span class="line">    # 组播信息发送间隔，也就是心跳时间，两个节点设置必须一样，默认1s</span><br><span class="line">    advert_int 1</span><br><span class="line">    # 设置验证信息，主从必须一致</span><br><span class="line">    authentication &#123;</span><br><span class="line">		# 设置验证类型，主要有PASS和AH两种</span><br><span class="line">        auth_type PASS</span><br><span class="line">		# 设置验证密码，同一个vrrp_instance下，MASTER和BACKUP的密码必须一致才能正常通信</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    # 设置虚拟路由器地址，即vip漂移地址</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.91.110</span><br><span class="line">    &#125;</span><br><span class="line">    # 引入脚本，名字必须与上面一致，如果不加，脚本不会运行</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_http_port</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>从机配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">   smtp_server 192.168.91.129</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id host1</span><br><span class="line">   script_user root</span><br><span class="line">   enable_script_security</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_http_port &#123;</span><br><span class="line">   script &quot;&#x2F;usr&#x2F;local&#x2F;src&#x2F;nginx_check.sh&quot;</span><br><span class="line">   interval 2</span><br><span class="line">   weight -20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance yx &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.91.110</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_http_port</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>添加检测脚本</strong>（vim /usr/local/src/nginx_check.sh）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">A=`ps -C nginx --no-header |wc -l`</span><br><span class="line"><span class="meta">#</span><span class="bash"> 判断Nginx是否存活，如果不存活则尝试启动Nginx</span></span><br><span class="line">if [ $A -eq 0 ];then</span><br><span class="line">    /usr/local/nginx/sbin/nginx</span><br><span class="line">    # 等待2秒后再次获取Nginx状态，该值应该要不大于nginx_check.sh中执行脚本的interval</span><br><span class="line">    sleep 2</span><br><span class="line">    # 再次判断，如果Nginx还不存活则停止keepalived，让地址进行漂移，并退出脚本</span><br><span class="line">    if [ `ps -C nginx --no-header |wc -l` -eq 0 ];then</span><br><span class="line">        killall keepalived</span><br><span class="line">    fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h6 id="Keepalived启停"><a href="#Keepalived启停" class="headerlink" title="Keepalived启停"></a>Keepalived启停</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启、关闭、重新加载、查看状态</span></span><br><span class="line">systemctl [start|stop|restart|status] keepalived.service</span><br><span class="line"><span class="comment"># 设置开机自启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> keepalived.service</span><br></pre></td></tr></table></figure>

<p><em>ps：在漂移到的主机上会多一个vip漂移地址（通过ifconfig查看）。</em></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:757224748@qq.com">Yez Sun</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://sunshine-boy-yez.github.io/2022/03/27/Nginx/">https://sunshine-boy-yez.github.io/2022/03/27/Nginx/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/03/27/Redis/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Redis</div></div></a></div><div class="next-post pull-right"><a href="/2021/09/12/Maven/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Maven</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/zhiZhu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Yez Sun</div><div class="author-info__description">Recording and sharing techniques</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">16</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">1</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Sunshine-boy-yez"><i class="fab fa-github"></i><span>GitHub主页</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Sunshine-boy-yez" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:757224748@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">Nginx简介</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Nginx%E5%9B%9B%E4%B8%AA%E5%B8%B8%E7%94%A8%E7%89%88%E6%9C%AC"><span class="toc-number">1.1.</span> <span class="toc-text">Nginx四个常用版本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Nginx%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.</span> <span class="toc-text">Nginx的安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E6%94%BE%E9%98%B2%E7%81%AB%E5%A2%99%E7%AB%AF%E5%8F%A3"><span class="toc-number">1.3.</span> <span class="toc-text">开放防火墙端口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Nginx%E5%90%AF%E5%81%9C"><span class="toc-number">1.4.</span> <span class="toc-text">Nginx启停</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%88%90%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.5.</span> <span class="toc-text">安装成系统服务</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">Nginx基本使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">2.1.</span> <span class="toc-text">目录结构</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#nginx-conf%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.1.1.</span> <span class="toc-text">nginx.conf配置文件</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">正向代理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">2.3.</span> <span class="toc-text">反向代理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">2.4.</span> <span class="toc-text">负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="toc-number">2.4.1.</span> <span class="toc-text">负载均衡策略</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="toc-number">2.5.</span> <span class="toc-text">动静分离</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#URLReWrite%E4%BC%AA%E9%9D%99%E6%80%81%E9%85%8D%E7%BD%AE"><span class="toc-number">2.6.</span> <span class="toc-text">URLReWrite伪静态配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9C%9F%E5%AE%9E%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%A6%81%E6%AD%A2%E5%A4%96%E7%BD%91%E8%AE%BF%E9%97%AE"><span class="toc-number">2.7.</span> <span class="toc-text">真实服务器禁止外网访问</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%98%B2%E7%9B%97%E9%93%BE%E9%85%8D%E7%BD%AE"><span class="toc-number">2.8.</span> <span class="toc-text">防盗链配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8curl%E6%B5%8B%E8%AF%95"><span class="toc-number">2.8.1.</span> <span class="toc-text">使用curl测试</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">2.9.</span> <span class="toc-text">高可用配置</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Keepalived"><span class="toc-number">2.9.1.</span> <span class="toc-text">安装Keepalived</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#keepalived-conf%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.9.2.</span> <span class="toc-text">keepalived.conf配置文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Keepalived%E5%90%AF%E5%81%9C"><span class="toc-number">2.9.3.</span> <span class="toc-text">Keepalived启停</span></a></li></ol></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/04/08/JVM/" title="No title"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="No title"/></a><div class="content"><a class="title" href="/2022/04/08/JVM/" title="No title">No title</a><time datetime="2022-04-08T05:43:23.068Z" title="Created 2022-04-08 13:43:23">2022-04-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/27/Mycat/" title="Mycat"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Mycat"/></a><div class="content"><a class="title" href="/2022/03/27/Mycat/" title="Mycat">Mycat</a><time datetime="2022-03-27T09:05:57.000Z" title="Created 2022-03-27 17:05:57">2022-03-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/27/Redis/" title="Redis"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis"/></a><div class="content"><a class="title" href="/2022/03/27/Redis/" title="Redis">Redis</a><time datetime="2022-03-27T05:50:00.000Z" title="Created 2022-03-27 13:50:00">2022-03-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/27/Nginx/" title="Nginx"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nginx"/></a><div class="content"><a class="title" href="/2022/03/27/Nginx/" title="Nginx">Nginx</a><time datetime="2022-03-27T05:49:31.000Z" title="Created 2022-03-27 13:49:31">2022-03-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/09/12/Maven/" title="Maven"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Maven"/></a><div class="content"><a class="title" href="/2021/09/12/Maven/" title="Maven">Maven</a><time datetime="2021-09-12T03:44:27.000Z" title="Created 2021-09-12 11:44:27">2021-09-12</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Yez Sun</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi,welcome to my blog!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    let initData = {
      el: '#vcomment',
      appId: 'DfTNQiPIqMxYLHKiQVi3sOKw-gzGzoHsz',
      appKey: 'xACoAvIgHoQB9zmTlylwPiwb',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'en',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('nick,mail'.split(','))
    }
    
    if (false) {
      const otherData = false
      initData = Object.assign({}, initData, otherData)
    }
    
    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script>((window.gitter = {}).chat = {}).options = {
  disableDefaultChat: true,
};
document.addEventListener('gitter-sidecar-ready', (e) => {
  const GitterChat = e.detail.Chat
  let chat

  function initGitter () {
    chat = new GitterChat({
      room: 'progressbytc/community',
      activationElement: '#chat_btn'
    });
  }

  initGitter()

  if (false) {
    document.addEventListener('pjax:complete', () => {
      chat.destroy()
      initGitter()
    })
  }

})</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async="async" defer="defer"></script></div></body></html>